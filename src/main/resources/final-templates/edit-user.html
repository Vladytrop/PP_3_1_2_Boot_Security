<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Редактирование пользователя - Админ панель</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

  <style>
    .form-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      background-color: #f8f9fa;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      margin-top: 3rem;
    }
    .header {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      padding: 2rem 0;
      margin-bottom: 2rem;
      border-radius: 0 0 10px 10px;
    }
    .btn-back {
      margin-bottom: 1rem;
    }
    .error-message {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .password-hint {
      font-size: 0.875rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }
    .role-select {
      min-height: 120px;
    }
    .card {
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
<!-- Хедер -->
<header class="header">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1><i class="bi bi-gear"></i> Административная панель</h1>
        <p class="mb-0">Редактирование пользователя</p>
      </div>
      <div>
        <a th:href="@{/admin}" class="btn btn-light">
          <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Основной контент -->
<div class="container">
  <!-- Карточка с формой -->
  <div class="card form-container">
    <div class="card-body">
      <h2 class="card-title mb-4 text-center">
        <i class="bi bi-person-gear me-2"></i>Редактировать пользователя
      </h2>

      <!-- Форма редактирования -->
      <form th:action="@{/admin/{id}(id=${user.id})}" th:object="${user}" method="post">
        <input type="hidden" name="_method" value="PATCH">

        <!-- Поле ID (только для чтения) -->
        <div class="mb-4">
          <label for="userId" class="form-label fw-bold">ID пользователя</label>
          <input type="text"
                 class="form-control"
                 id="userId"
                 th:value="${user.id}"
                 readonly
                 disabled
                 style="background-color: #e9ecef;">
          <small class="text-muted">Идентификатор пользователя нельзя изменить</small>
        </div>

        <!-- Поле Username -->
        <div class="mb-4">
          <label for="username" class="form-label fw-bold">
            <i class="bi bi-person-circle me-1"></i>Имя пользователя
          </label>
          <input type="text"
                 class="form-control"
                 id="username"
                 th:field="*{username}"
                 th:classappend="${#fields.hasErrors('username')} ? 'is-invalid' : ''"
                 required>
          <div th:if="${#fields.hasErrors('username')}" class="invalid-feedback">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span th:errors="*{username}"></span>
          </div>
        </div>

        <!-- Поле Email (если есть в модели) -->
        <div class="mb-4" th:if="${user.email != null}">
          <label for="email" class="form-label fw-bold">
            <i class="bi bi-envelope me-1"></i>Email адрес
          </label>
          <input type="email"
                 class="form-control"
                 id="email"
                 th:field="*{email}"
                 th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''">
          <div th:if="${#fields.hasErrors('email')}" class="invalid-feedback">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span th:errors="*{email}"></span>
          </div>
        </div>

        <!-- Поле Пароля -->
        <div class="mb-4">
          <label for="password" class="form-label fw-bold">
            <i class="bi bi-key me-1"></i>Новый пароль
          </label>
          <input type="password"
                 class="form-control"
                 id="password"
                 name="password"
                 th:classappend="${#fields.hasErrors('password')} ? 'is-invalid' : ''"
                 placeholder="Введите новый пароль">
          <div th:if="${#fields.hasErrors('password')}" class="invalid-feedback">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span th:errors="*{password}"></span>
          </div>
          <div class="password-hint">
            <i class="bi bi-info-circle"></i> Оставьте поле пустым, если не хотите менять пароль
          </div>
        </div>

        <!-- Подтверждение пароля (если нужно) -->
        <div class="mb-4">
          <label for="confirmPassword" class="form-label fw-bold">
            <i class="bi bi-key-fill me-1"></i>Подтверждение пароля
          </label>
          <input type="password"
                 class="form-control"
                 id="confirmPassword"
                 name="confirmPassword"
                 placeholder="Повторите новый пароль">
          <div class="password-hint">
            <i class="bi bi-info-circle"></i> Подтвердите новый пароль для проверки
          </div>
        </div>

        <!-- Поле Роли -->
        <div class="mb-4">
          <label for="roles" class="form-label fw-bold">
            <i class="bi bi-shield-check me-1"></i>Роли пользователя
          </label>
          <select class="form-select role-select"
                  id="roles"
                  name="roleIds"
                  multiple
                  th:classappend="${#fields.hasErrors('roleIds')} ? 'is-invalid' : ''">
            <option th:each="role : ${allRoles}"
                    th:value="${role.id}"
                    th:text="${role.name}"
                    th:selected="${#lists.contains(user.roles.![id], role.id)}">
            </option>
          </select>
          <div th:if="${#fields.hasErrors('roleIds')}" class="invalid-feedback">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span th:errors="*{roleIds}"></span>
          </div>
          <div class="form-text">
            <i class="bi bi-mouse"></i> Для выбора нескольких ролей удерживайте клавишу Ctrl (Cmd на Mac)
          </div>
        </div>

        <!-- Поле Активности (если есть в модели) -->
        <div class="mb-4" th:if="${user.enabled != null}">
          <div class="form-check form-switch">
            <input class="form-check-input"
                   type="checkbox"
                   id="enabled"
                   th:checked="${user.enabled}"
                   name="enabled">
            <label class="form-check-label fw-bold" for="enabled">
              <i class="bi bi-power me-1"></i>Аккаунт активен
            </label>
          </div>
          <div class="form-text">
            Определяет, может ли пользователь входить в систему
          </div>
        </div>

        <!-- Дополнительная информация (если есть) -->
        <div class="mb-4" th:if="${user.createdAt != null}">
          <div class="card bg-light">
            <div class="card-body">
              <h6 class="card-subtitle mb-2 text-muted">
                <i class="bi bi-info-circle me-1"></i>Дополнительная информация
              </h6>
              <p class="card-text mb-1" th:if="${user.createdAt}">
                <strong>Создан:</strong>
                <span th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
              </p>
              <p class="card-text mb-1" th:if="${user.updatedAt}">
                <strong>Обновлен:</strong>
                <span th:text="${#temporals.format(user.updatedAt, 'dd.MM.yyyy HH:mm')}"></span>
              </p>
              <p class="card-text mb-0" th:if="${user.lastLogin}">
                <strong>Последний вход:</strong>
                <span th:text="${#temporals.format(user.lastLogin, 'dd.MM.yyyy HH:mm')}"></span>
              </p>
            </div>
          </div>
        </div>

        <!-- Кнопки действий -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 pt-3 border-top">
          <button type="button"
                  class="btn btn-outline-secondary me-2"
                  onclick="history.back()">
            <i class="bi bi-x-circle me-1"></i>Отмена
          </button>
          <a th:href="@{/admin/{id}/delete(id=${user.id})}"
             class="btn btn-outline-danger me-2"
             onclick="return confirm('Вы уверены, что хотите удалить этого пользователя?')">
            <i class="bi bi-trash me-1"></i>Удалить
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-1"></i>Сохранить изменения
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Дополнительный JavaScript для валидации паролей -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const password = document.getElementById('password');
    const confirmPassword = document.getElementById('confirmPassword');

    // Проверка совпадения паролей перед отправкой
    form.addEventListener('submit', function(event) {
      if (password.value && confirmPassword.value && password.value !== confirmPassword.value) {
        event.preventDefault();
        alert('Пароли не совпадают!');
        confirmPassword.focus();
      }
    });

    // Динамическая проверка паролей
    function checkPasswords() {
      if (password.value && confirmPassword.value && password.value !== confirmPassword.value) {
        confirmPassword.classList.add('is-invalid');
        confirmPassword.classList.remove('is-valid');
      } else if (confirmPassword.value) {
        confirmPassword.classList.remove('is-invalid');
        confirmPassword.classList.add('is-valid');
      } else {
        confirmPassword.classList.remove('is-invalid', 'is-valid');
      }
    }

    password.addEventListener('input', checkPasswords);
    confirmPassword.addEventListener('input', checkPasswords);

    // Подсказка о сложности пароля
    password.addEventListener('focus', function() {
      const hint = document.createElement('div');
      hint.className = 'form-text';
      hint.innerHTML = '<i class="bi bi-lightbulb"></i> Пароль должен содержать минимум 6 символов';
      if (!this.nextElementSibling.classList.contains('form-text')) {
        this.parentNode.insertBefore(hint, this.nextElementSibling);
      }
    });
  });
</script>
</body>
</html>