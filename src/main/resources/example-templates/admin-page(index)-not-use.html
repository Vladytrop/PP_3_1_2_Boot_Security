<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Management</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        .admin-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        .admin-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .admin-title h2 {
            color: #2c3e50;
            font-weight: 600;
            margin: 0;
        }
        .table-container {
            overflow-x: auto;
        }
        .admin-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
        }
        .admin-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }
        .admin-table td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #e9ecef;
        }
        .admin-table tr:hover {
            background-color: #f8f9fa;
        }
        .table-name {
            font-weight: 500;
            color: #2c3e50;
        }
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .modal-title {
            color: #2c3e50;
            font-weight: 600;
        }
        .form-space {
            margin-bottom: 20px;
        }
        .user-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-admin {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .badge-editor {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        .badge-user {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
<div class="container-fluid py-4">
    <!-- Admin Table Card -->
    <div class="admin-card">
        <div class="admin-title">
            <h2>Users Management</h2>
            <button class="btn btn-primary" onclick="showAddModal()">
                <i class="bi bi-plus-lg"></i> Add User
            </button>
        </div>

        <div class="table-container">
            <table class="admin-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>User Type</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="usersTableBody">
                <!-- Users will be dynamically populated here -->
                <tr>
                    <td colspan="6" class="text-center py-5 text-muted">
                        Loading users...
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="form-space">
                        <label for="fullName" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="fullName" required>
                        <div class="invalid-feedback" id="fullNameError"></div>
                    </div>

                    <div class="form-space">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" required>
                        <div class="invalid-feedback" id="emailError"></div>
                    </div>

                    <div class="form-space">
                        <label for="password" class="form-label">Password *</label>
                        <input type="password" class="form-control" id="password" required>
                        <div class="invalid-feedback" id="passwordError"></div>
                    </div>

                    <div class="form-space">
                        <label for="roleSelect" class="form-label">User Type *</label>
                        <select class="form-select" id="roleSelect" required>
                            <option value="" selected disabled>Select user type</option>
                            <!-- Roles will be populated dynamically -->
                        </select>
                        <div class="invalid-feedback" id="roleError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="addUserBtn" onclick="addUser()">
                    Add User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">

                    <div class="form-space">
                        <label for="editFullName" class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="editFullName" required>
                        <div class="invalid-feedback" id="editFullNameError"></div>
                    </div>

                    <div class="form-space">
                        <label for="editEmail" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="editEmail" required>
                        <div class="invalid-feedback" id="editEmailError"></div>
                    </div>

                    <div class="form-space">
                        <label for="editPassword" class="form-label">Password (Leave blank to keep unchanged)</label>
                        <input type="password" class="form-control" id="editPassword">
                        <div class="invalid-feedback" id="editPasswordError"></div>
                    </div>

                    <div class="form-space">
                        <label for="editRoleSelect" class="form-label">User Type *</label>
                        <select class="form-select" id="editRoleSelect" required>
                            <option value="" disabled>Select user type</option>
                            <!-- Roles will be populated dynamically -->
                        </select>
                        <div class="invalid-feedback" id="editRoleError"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="editUserBtn" onclick="updateUser()">
                    Update User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> Delete Confirmation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user?</p>
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteConfirmBtn" onclick="deleteUser()">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- Axios for HTTP requests -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    // State management
    const state = {
        users: [],
        roles: [],
        currentEditIndex: -1,
        currentDeleteIndex: -1,
        loading: false
    };

    // Modal instances
    let addModal = null;
    let editModal = null;
    let deleteModal = null;

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Bootstrap modals
        addModal = new bootstrap.Modal(document.getElementById('addUserModal'));
        editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        // Load initial data
        loadData();
    });

    // Load users and roles
    async function loadData() {
        try {
            showLoading();
            const [usersRes, rolesRes] = await Promise.all([
                axios.get('app/get_users'),
                axios.get('app/get_roles')
            ]);

            if (usersRes.status === 200) {
                state.users = usersRes.data;
                renderUsersTable();
            }

            if (rolesRes.status === 200) {
                state.roles = rolesRes.data;
                populateRoleSelects();
            }
        } catch (error) {
            console.error('Error loading data:', error);
            showError('Failed to load data. Please try again.');
        } finally {
            hideLoading();
        }
    }

    // Render users table
    function renderUsersTable() {
        const tbody = document.getElementById('usersTableBody');

        if (state.users.length === 0) {
            tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">
                            No users found
                        </td>
                    </tr>
                `;
            return;
        }

        tbody.innerHTML = state.users.map((user, index) => `
                <tr>
                    <td>${user.id}</td>
                    <td class="table-name">${user.fullName || '-'}</td>
                    <td>${user.email}</td>
                    <td>
                        <span class="user-badge ${getBadgeClass(user.userType)}">
                            ${user.userType}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-info" onclick="showEditModal(${index})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="showDeleteConfirmation(${index})">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
    }

    // Get badge class based on user type
    function getBadgeClass(userType) {
        switch(userType?.toLowerCase()) {
            case 'admin': return 'badge-admin';
            case 'editor': return 'badge-editor';
            case 'user': return 'badge-user';
            default: return 'badge-user';
        }
    }

    // Format date
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    // Populate role dropdowns
    function populateRoleSelects() {
        const addSelect = document.getElementById('roleSelect');
        const editSelect = document.getElementById('editRoleSelect');

        const options = state.roles.map(role =>
            `<option value="${role.id}">${role.roleName}</option>`
        ).join('');

        addSelect.innerHTML = `
                <option value="" selected disabled>Select user type</option>
                ${options}
            `;

        editSelect.innerHTML = `
                <option value="" disabled>Select user type</option>
                ${options}
            `;
    }

    // Show add modal
    function showAddModal() {
        document.getElementById('addUserForm').reset();
        clearValidationErrors('addUserForm');
        addModal.show();
    }

    // Show edit modal
    function showEditModal(index) {
        const user = state.users[index];
        if (!user) return;

        state.currentEditIndex = index;

        document.getElementById('editUserId').value = user.id;
        document.getElementById('editFullName').value = user.fullName || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editPassword').value = '';
        document.getElementById('editRoleSelect').value = user.role_id || '';

        clearValidationErrors('editUserForm');
        editModal.show();
    }

    // Show delete confirmation
    function showDeleteConfirmation(index) {
        state.currentDeleteIndex = index;
        deleteModal.show();
    }

    // Add new user
    async function addUser() {
        const btn = document.getElementById('addUserBtn');
        const originalText = btn.innerHTML;

        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Adding...';

            const userData = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value.trim(),
                role_id: document.getElementById('roleSelect').value
            };

            // Validate
            if (!validateUserForm('add', userData)) return;

            const response = await axios.post('app/create_user', userData);

            if (response.status === 201) {
                state.users.unshift(response.data);
                renderUsersTable();
                addModal.hide();
                showSuccess('User added successfully!');
                document.getElementById('addUserForm').reset();
            }
        } catch (error) {
            handleApiError(error, 'add');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Update user
    async function updateUser() {
        const btn = document.getElementById('editUserBtn');
        const originalText = btn.innerHTML;

        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Updating...';

            const userData = {
                id: document.getElementById('editUserId').value,
                fullName: document.getElementById('editFullName').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                role_id: document.getElementById('editRoleSelect').value
            };

            const password = document.getElementById('editPassword').value.trim();
            if (password) {
                userData.password = password;
            }

            // Validate
            if (!validateUserForm('edit', userData)) return;

            const response = await axios.post('app/edit_user', userData);

            if (response.status === 200) {
                state.users[state.currentEditIndex] = {
                    ...state.users[state.currentEditIndex],
                    ...userData
                };
                renderUsersTable();
                editModal.hide();
                showSuccess('User updated successfully!');
            }
        } catch (error) {
            handleApiError(error, 'edit');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Delete user
    async function deleteUser() {
        const btn = document.getElementById('deleteConfirmBtn');
        const originalText = btn.innerHTML;
        const user = state.users[state.currentDeleteIndex];

        if (!user) return;

        try {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Deleting...';

            const response = await axios.post('app/delete_user', { id: user.id });

            if (response.status === 200) {
                state.users.splice(state.currentDeleteIndex, 1);
                renderUsersTable();
                deleteModal.hide();
                showSuccess('User deleted successfully!');
            }
        } catch (error) {
            console.error('Delete error:', error);
            showError('Failed to delete user. Please try again.');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // Form validation
    function validateUserForm(type, data) {
        let isValid = true;
        const prefix = type === 'add' ? '' : 'edit';

        // Clear previous errors
        clearValidationErrors(type === 'add' ? 'addUserForm' : 'editUserForm');

        // Validate full name
        if (!data.fullName) {
            showFieldError(`${prefix}fullName`, 'Full name is required');
            isValid = false;
        }

        // Validate email
        if (!data.email) {
            showFieldError(`${prefix}email`, 'Email is required');
            isValid = false;
        } else if (!isValidEmail(data.email)) {
            showFieldError(`${prefix}email`, 'Please enter a valid email');
            isValid = false;
        }

        // Validate password for add form
        if (type === 'add' && !data.password) {
            showFieldError('password', 'Password is required');
            isValid = false;
        }

        // Validate role
        if (!data.role_id) {
            showFieldError(`${prefix}roleSelect`, 'User type is required');
            isValid = false;
        }

        return isValid;
    }

    // Email validation
    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // Show field error
    function showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(fieldId + 'Error');

        if (field && errorElement) {
            field.classList.add('is-invalid');
            errorElement.textContent = message;
        }
    }

    // Clear validation errors
    function clearValidationErrors(formId) {
        const form = document.getElementById(formId);
        if (!form) return;

        form.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });

        form.querySelectorAll('.invalid-feedback').forEach(el => {
            el.textContent = '';
        });
    }

    // Handle API errors
    function handleApiError(error, type) {
        if (error.response?.status === 422) {
            const errors = error.response.data.errors;
            for (const field in errors) {
                const fieldId = type === 'add' ? field : `edit${field.charAt(0).toUpperCase() + field.slice(1)}`;
                showFieldError(fieldId, errors[field][0]);
            }
        } else {
            showError('An error occurred. Please try again.');
        }
    }

    // Utility functions
    function showLoading() {
        state.loading = true;
        // You can add a loading spinner here
    }

    function hideLoading() {
        state.loading = false;
    }

    function showSuccess(message) {
        // You can implement a toast notification here
        alert('Success: ' + message);
    }

    function showError(message) {
        // You can implement a toast notification here
        alert('Error: ' + message);
    }
</script>
</body>
</html>