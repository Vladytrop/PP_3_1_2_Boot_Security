<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Панель администратора</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<!--Верхняя панель-->
<nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-text text-white">
        Админ с именем:
        <span th:text="${currentUsername}"></span>
    </span>
  <form th:action="@{/logout}" method="post">
    <button type="submit" class="btn btn-outline-light btn-sm">Выйти</button>
  </form>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- Сайдбар -->
    <aside class="col-2 bg-white border-end vh-100 p-3">
      <div class="list-group">
        <button id="adminTabBtn" class="list-group-item list-group-item-action">Admin</button>
        <button id="userTabBtn" class="list-group-item list-group-item-action">User</button>
      </div>
    </aside>

    <!-- Основной контент -->
    <main class="col-10 p-4">
      <h2>Панель администратора</h2>

      <!-- Табы -->
      <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
          <a class="nav-link active" href="#usersTab" data-bs-toggle="tab">Таблица пользователей</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#createTab" data-bs-toggle="tab">Новый пользователь</a>
        </li>
      </ul>

      <!-- Контент табов -->
      <div class="tab-content">
        <!-- Таблица пользователей -->
        <div class="tab-pane fade show active" id="usersTab">
          <div class="card">
            <div class="card-header fw-bold">
              Все пользователи
            </div>
            <div class="card-body">
              <table class="table table-striped align-middle">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>Имя пользователя</th>
                  <th>Роль</th>
                  <th>Редактировать</th>
                  <th>Удалить</th>
                </tr>
                </thead>
                <tbody id="usersTableBody">
                <!-- JS динамически заполнит -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Создание пользователя -->
        <div class="tab-pane fade" id="createTab">
          <div class="card">
            <div class="card-header fw-bold">
              Создание нового пользователя
            </div>
            <div class="card-body">
              <form id="createUserForm">
                <div class="mb-3">
                  <label for="username" class="form-label">Имя пользователя</label>
                  <input type="text" class="form-control" id="username" placeholder="Введите имя пользователя" required>
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Пароль</label>
                  <input type="password" class="form-control" id="password" placeholder="Введите пароль" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Роль</label>
                  <select class="form-select" multiple size="2" id="roleSelect">
                    <option value="1">ROLE_USER</option>
                    <option value="3">ROLE_ADMIN</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">Создать пользователя</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Шаблон модального окна редактирования (клонируется JS) -->
<div class="modal fade" id="editModalTemplate" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Редактировать пользователя</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form class="editUserForm">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">ID</label>
            <input type="text" class="form-control userIdInput" readonly disabled>
          </div>
          <div class="mb-3">
            <label class="form-label">Имя пользователя</label>
            <input type="text" class="form-control usernameInput" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Пароль</label>
            <input type="password" class="form-control passwordInput" placeholder="Введите новый пароль">
            <small class="text-muted">Оставьте пустым, если не хотите менять пароль</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Роль</label>
            <select class="form-select rolesInput" multiple size="2">
              <option value="1">ROLE_USER</option>
              <option value="3">ROLE_ADMIN</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Сохранить</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let users = []; // массив всех пользователей

  // Добавление строки пользователя в таблицу
  function addUserRow(user) {
    const tbody = document.getElementById('usersTableBody');
    const tr = document.createElement('tr');
    tr.dataset.id = user.id;

    tr.innerHTML = `
        <td>${user.id}</td>
        <td>${user.username}</td>
        <td>${user.roles.map(r => r.name).join(', ')}</td>
        <td><button class="btn btn-info btn-sm editBtn">Редактировать</button></td>
        <td><button class="btn btn-danger btn-sm deleteBtn">Удалить</button></td>
    `;
    tbody.appendChild(tr);

    // Кнопка редактирования
    tr.querySelector('.editBtn').addEventListener('click', () => openEditModal(user));

    // Кнопка удаления
    tr.querySelector('.deleteBtn').addEventListener('click', () => deleteUser(user.id, tr));
  }

  // Загрузка всех пользователей
  function loadUsers() {
    fetch('/api/users')
            .then(res => res.json())
            .then(data => {
              users = data;
              const tbody = document.getElementById('usersTableBody');
              tbody.innerHTML = '';
              data.forEach(user => addUserRow(user));
            })
            .catch(err => console.error(err));
  }

  // Открыть модальное окно редактирования
  function openEditModal(user) {
    const modalTemplate = document.getElementById('editModalTemplate');
    const modalClone = modalTemplate.cloneNode(true);
    modalClone.id = 'editModal' + user.id;

    modalClone.querySelector('.userIdInput').value = user.id;
    modalClone.querySelector('.usernameInput').value = user.username;
    const rolesSelect = modalClone.querySelector('.rolesInput');
    Array.from(rolesSelect.options).forEach(opt => {
      opt.selected = user.roles.some(r => r.id === Number(opt.value));
    });

    document.body.appendChild(modalClone);
    const bsModal = new bootstrap.Modal(modalClone);
    bsModal.show();

    modalClone.querySelector('.editUserForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const updatedUser = {
        username: modalClone.querySelector('.usernameInput').value,
        password: modalClone.querySelector('.passwordInput').value,
        roles: Array.from(modalClone.querySelector('.rolesInput').selectedOptions)
                .map(o => ({id: Number(o.value), name: o.text}))

      };

      fetch('/api/users/' + user.id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(updatedUser)
      })
              .then(res => res.json())
              .then(data => {
                const row = document.querySelector(`tr[data-id="${user.id}"]`);
                row.children[1].textContent = data.username;
                row.children[2].textContent = data.roles.map(r => r.name).join(', ');
                bsModal.hide();
                modalClone.remove();
              })
              .catch(err => console.error(err));
    });

    modalClone.addEventListener('hidden.bs.modal', () => modalClone.remove());
  }

  // Удаление пользователя
  function deleteUser(id, rowElement) {
    if (!confirm('Вы уверены, что хотите удалить пользователя?')) return;
    fetch('/api/users/' + id, {method: 'DELETE'})
            .then(res => {
              if (res.ok) rowElement.remove();
            })
            .catch(err => console.error(err));
  }

  // Создание нового пользователя
  document.getElementById('createUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const selectedRoles = Array.from(document.getElementById('roleSelect').selectedOptions)
            .map(o => ({ id: Number(o.value), name: o.text }));

    fetch('/api/users', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        username: username,
        password: password,
        roles: selectedRoles
      })
    })
            .then(res => res.json())
            .then(user => {
              addUserRow(user);
              this.reset();
              bootstrap.Tab.getOrCreateInstance(document.querySelector('a[href="#usersTab"]')).show();
            })
            .catch(err => console.error(err));

  });

  // Admin — показывает всех пользователей
  document.getElementById('adminTabBtn').addEventListener('click', function() {
    loadUsers(); // функция уже есть
    document.getElementById('usersTab').classList.add('show','active');
    document.getElementById('createTab').classList.remove('show','active');
  });

  // User — показывает текущего пользователя
  document.getElementById('userTabBtn').addEventListener('click', function() {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = ''; // очищаем таблицу

    // Получаем текущего пользователя с сервера
    fetch('/api/users/current') // здесь должен быть endpoint, который отдаёт текущего залогиненного пользователя
            .then(res => res.json())
            .then(user => {
              addUserRow(user); // используем ту же функцию для добавления строки в таблицу
              document.getElementById('usersTab').classList.add('show','active');
              document.getElementById('createTab').classList.remove('show','active');
            })
            .catch(err => console.error(err));
  });


  // Инициализация
  loadUsers();

</script>
</body>
</html>
